angular.module("fg.modal",["ngAnimate"]).factory("ModalTemplate",["$document","$compile","$rootScope","$http","$templateCache","$q","$animate","$injector","$controller",function(e,t,n,r,o,s,i,a,l){function c(e){this.templateUrl=e.templateUrl,this.template=e.template,this.containerUrl=e.containerUrl,this.controller=e.controller,this.controllerAs=e.controllerAs,this.resolve=e.resolve||{},this.defaults=_.mapValues(e.defaults||{},v)}function d(){var e=this;this.$$deferredEvents={},this.$$eventListeners={},f.forEach(function(t){e.$$deferredEvents[t]=s.defer(),e.$$eventListeners[t]=[]}),this.$$pendingEvents=[]}var u=n.$new(),h=[],$='<div class="fg-modal-wrapper fg-modal-dropzone ng-hide" ng-show="show" />',f=["destroy","link","accept","dismiss"],p=t(angular.element($))(u),v=function(e){return Array.isArray(e)?e:[e]};d.prototype.$$trigger=function(e){this.$$eventListeners[e].forEach(function(e){e()})},d.prototype.$$resolve=function(e){var t=this,n=t.$$deferredEvents[e];if(this.$$pendingEvents.indexOf(e)>-1)return n.promise;this.$$pendingEvents.push(e);var r=t.$$eventListeners[e],o=r.map(function(e){return s.when(e())});return s.all(o).then(function(){return n.resolve(),n.promise},function(n){var r=t.$$pendingEvents.indexOf(e);return t.$$pendingEvents.splice(r,1),s.reject(n)})},d.prototype.accept=function(){this.$$resolve("accept").then(this.destroy.bind(this))},d.prototype.dismiss=function(){return this.$$resolve("dismiss").then(this.destroy.bind(this))};var m=function(){return i.leave(this.$element)},y=function(){var e=this,t=_.findIndex(h,function(t){return t.$scope.$$id===e.$scope.$$id});h.splice(t,1),u.show=h.length,e.$scope.$destroy()},g=function(){var e=this.$$deferredEvents;e.accept.reject(),e.dismiss.reject()};return d.prototype.destroy=function(){return this.$$resolve("destroy").then(m.bind(this)).then(y.bind(this)).then(g.bind(this)).then(this.$$deferredEvents.destroy.resolve)},d.prototype.when=function(e){return this.$$deferredEvents[e].promise},d.prototype.on=function(e,t){if(Array.isArray(t))return t.forEach(this.on.bind(this,e));var n=this;return e.split(" ").forEach(function(e){n.$$eventListeners[e].push(t.bind(n))}),n},e.find("body").append(p),p.on("mouseup",function(e){angular.element(e.target).hasClass("fg-modal-dropzone")&&h.forEach(function(e){e.dismiss()})}),c.prototype.inherit=function(e){var t=new c(_.defaults(e,this));for(var n in this.defaults){var r=v(this.defaults[n]);t.defaults[n]=n in e.defaults?t.defaults[n].concat(r):r}return t},c.prototype.render=function(e){var c=new d,$=this,f=$.containerUrl;e=e||{},e=e.constructor!==n.constructor?angular.extend(u.$new(),e):e.$new(),e.$modal=c,u.show=u.show;var v={locals:s.all(Object.keys($.resolve).reduce(function(e,t){return e[t]=s.when(a.invoke($.resolve[t])),e},{$scope:e,$modal:c})),template:s.when($.template||r({method:"GET",cache:o,url:$.templateUrl,type:"text/html"}))};return f&&(v.container=s.when($.container||r({method:"GET",cache:o,url:$.containerUrl,type:"text/html"}))),s.all(v).then(function(n){var r,o=function(e){return angular.element(e).addClass("fg-modal")},s=o(f?n.container.data:n.template.data),a=f&&{parentBoundTranscludeFn:function(r,o){t(n.template.data)(e,o)}},d=function(t,o){c.$scope=e,$.controller&&(r=l($.controller,n.locals)),u.loading=!1,u.show=!0,$.controllerAs&&(e[$.controllerAs]=r);var s=_.last(h);i.enter(t,p,s&&s.$element),c.$element=t,h.unshift(c),c.$$trigger("link")};t(s)(e,d,a)}),Object.keys($.defaults).forEach(function(e){var t=$.defaults[e];t&&(Array.isArray(t)?t:[t]).forEach(function(t){c.on(e,t)})}),c},c}]);