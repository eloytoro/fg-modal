angular.module("fgModal", ["ngAnimate"]).provider("Modal", function() {
    var e = function(e, n) {
            this.templateUrl = n.templateUrl, this.template = n.template, this.defaults = n.defaults || {}, this.controller = n.controller, this.resolve = n.resolve || {}, this.name = e
        },
        n = {},
        t = this;
    this.modal = function(o, i) {
        return n[o] = function(n) {
            var t = n.invoke(i);
            return new e(o, t)
        }, t
    }, this.$get = ["$document", "$compile", "$rootScope", "$http", "$templateCache", "$q", "$animate", "$injector", "$controller", function(t, o, i, r, c, s, l, a, u) {
        Object.keys(n).forEach(function(e) {
            n[e] = n[e](a)
        });
        var f, h = i.$new(),
            d = [],
            p = function(e) {
                var n = this,
                    t = {
                        accept: s.defer(),
                        dismiss: s.defer(),
                        destroy: s.defer()
                    },
                    o = {
                        link: [],
                        overlay: [],
                        conceal: [],
                        accept: [],
                        dismiss: [],
                        destroy: []
                    },
                    i = function(e) {
                        return s.all(o[e].map(function(e) {
                            return s.when(e())
                        })).then(function() {
                            return t[e].resolve(), t[e].promise
                        })
                    },
                    r = function(e) {
                        o[e].forEach(function(e) {
                            e()
                        })
                    };
                this.$template = e, this.$index = 0, this.accept = function() {
                    return i("accept").then(n.destroy)
                }, this.dismiss = function() {
                    return i("dismiss").then(n.destroy)
                }, this.destroy = function() {
                    return i("destroy").then(function() {
                        var e = d.indexOf(n);
                        d.splice(e, 1), n.$element.remove(), d.forEach(function(e) {
                            e.$index > n.$index && e.overlay()
                        }), h.show = d.length, n.$scope.$destroy()
                    })
                }, this.when = function(e) {
                    return t[e].promise
                }, this.link = function(t, o, i) {
                    n.$element = o, n.$scope = t, e.controller && (i.$scope = t, i.$modal = n, i.$element = o, u(e.controller, i)), f.append(o), n.$element.css("z-index", 1e4), d.forEach(function(e) {
                        e.conceal()
                    }), d.unshift(n), h.show = !0, r("link")
                }, this.overlay = function() {
                    0 !== n.$index && (n.$element.css("z-index", "+=1"), n.$index--, r("overlay"))
                }, this.conceal = function() {
                    n.$element.css("z-index", "-=1"), n.$index++, r("conceal")
                }, this.on = function(e, t) {
                    return e.split(" ").forEach(function(e) {
                        o[e].push(t.bind(n))
                    }), n
                }
            };
        o(angular.element('<div class="fg-modal-wrapper ng-hide" ng-show="show"></div>'))(h, function(e) {
            f = e, t.find("body").append(f)
        }), e.prototype.pop = function(e) {
            var n = new p(this);
            if (e = e || {}, e.$id) e = e.$new();
            else {
                var t = i.$new();
                for (var l in e) t[l] = e[l];
                e = t
            }
            e.$modal = n;
            var u = this;
            return s.all({
                locals: s.all(Object.keys(this.resolve).reduce(function(e, n) {
                    return e[n] = s.when(a.invoke(u.resolve[n])), e
                }, {})),
                template: s.when(this.template || r({
                    method: "GET",
                    cache: c,
                    url: this.templateUrl,
                    type: "text/html"
                }))
            }).then(function(t) {
                o(t.template.data)(e, function(o) {
                    n.link(e, o, t.locals)
                })
            }), Object.keys(this.defaults).forEach(function(e) {
                var t = u.defaults[e];
                (t instanceof Array ? t : [t]).forEach(function(t) {
                    n.on(e, t)
                })
            }), n
        };
        var m = function(e) {
            return e ? n[e] : d[0]
        };
        return m.list = function() {
            return d.sort(function(e, n) {
                return e.$index > n.$index
            })
        }, m
    }]
});
